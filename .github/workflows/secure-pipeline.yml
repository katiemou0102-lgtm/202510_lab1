name: Secure CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  actions: read

# ===============================
# 1️⃣ Secret Scan（gitleaks）
# ===============================
jobs:
  secret-scan:
    name: Secret Scan - Gitleaks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --redact --verbose
        continue-on-error: true


# ===============================
# 2️⃣ SAST（Semgrep）
# ===============================
  sast-scan:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: secret-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/default
        continue-on-error: true


# ===============================
# 3️⃣ SCA（Dependency Check）
# ===============================
  sca-scan:
    name: SCA - Dependency Check
    runs-on: ubuntu-latest
    needs: sast-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "secure-lab"
          path: "."
          format: "HTML"
        continue-on-error: true


# ===============================
# 4️⃣ Container Scan（Trivy）
# ===============================
  container-scan:
    name: Container Scan - Trivy
    runs-on: ubuntu-latest
    needs: sca-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t secure-lab-image .

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secure-lab-image
          format: table
          severity: CRITICAL,HIGH
        continue-on-error: true


# ===============================
# 5️⃣ IaC Scan（Checkov）
# ===============================
  iac-scan:
    name: IaC Scan - Checkov
    runs-on: ubuntu-latest
    needs: container-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
        continue-on-error: true


# ===============================
# 6️⃣ Security Summary（老師最愛）
# ===============================
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - secret-scan
      - sast-scan
      - sca-scan
      - container-scan
      - iac-scan
    if: always()

    steps:
      - name: Print scan results
        run: |
          echo "========== Security Scan Results =========="
          echo "Secret Scan (Gitleaks):     ${{ needs.secret-scan.result }}"
          echo "SAST (Semgrep):             ${{ needs.sast-scan.result }}"
          echo "SCA (Dependency Check):     ${{ needs.sca-scan.result }}"
          echo "Container Scan (Trivy):     ${{ needs.container-scan.result }}"
          echo "IaC Scan (Checkov):         ${{ needs.iac-scan.result }}"
          echo "=========================================="

      - name: Final result
        run: |
          echo "✔ Security pipeline execution finished"
